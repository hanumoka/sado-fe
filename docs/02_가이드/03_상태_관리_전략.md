# 상태 관리 전략

> **Zustand + TanStack Query 조합 (2025 권장)**

---

## 개요

### 2025 상태 관리 트렌드

| 접근 방식 | 설명 | 사용 시점 |
|----------|------|----------|
| **Server State** | API 데이터, 캐싱 | TanStack Query |
| **Client State** | UI 상태, 인증 | Zustand |

**핵심 원칙**: 서버 상태와 클라이언트 상태를 분리하여 관리

### 왜 이 조합인가?

| 라이브러리 | 장점 | 단점 |
|-----------|------|------|
| **Zustand** | 간결한 API, 적은 보일러플레이트 | 서버 상태 관리 부적합 |
| **TanStack Query** | 강력한 캐싱, 자동 동기화 | 클라이언트 상태에 과함 |

**결론**: 각각의 강점을 살려 조합 사용

---

## Zustand 설정

### 설치

```bash
npm install zustand
```

### 기본 스토어 구조

```typescript
// src/stores/authStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: string;
  name: string;
  email: string;
  tenantId: string;
}

interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;

  // Actions
  setUser: (user: User) => void;
  setToken: (token: string) => void;
  logout: () => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      token: null,
      isAuthenticated: false,

      setUser: (user) => set({ user, isAuthenticated: true }),
      setToken: (token) => set({ token }),
      logout: () => set({ user: null, token: null, isAuthenticated: false }),
    }),
    {
      name: 'auth-storage', // localStorage key
    }
  )
);
```

### UI 상태 스토어

```typescript
// src/stores/uiStore.ts
import { create } from 'zustand';

interface UIState {
  sidebarOpen: boolean;
  theme: 'light' | 'dark' | 'system';

  toggleSidebar: () => void;
  setTheme: (theme: 'light' | 'dark' | 'system') => void;
}

export const useUIStore = create<UIState>((set) => ({
  sidebarOpen: true,
  theme: 'system',

  toggleSidebar: () => set((state) => ({ sidebarOpen: !state.sidebarOpen })),
  setTheme: (theme) => set({ theme }),
}));
```

### 스토어 사용

```typescript
// 컴포넌트에서 사용
import { useAuthStore } from '@/stores/authStore';
import { useUIStore } from '@/stores/uiStore';

function Header() {
  const { user, logout } = useAuthStore();
  const { sidebarOpen, toggleSidebar } = useUIStore();

  return (
    <header>
      <button onClick={toggleSidebar}>
        {sidebarOpen ? 'Close' : 'Open'}
      </button>
      {user && (
        <div>
          <span>{user.name}</span>
          <button onClick={logout}>Logout</button>
        </div>
      )}
    </header>
  );
}
```

---

## TanStack Query 설정

### 설치

```bash
npm install @tanstack/react-query
npm install -D @tanstack/react-query-devtools
```

### QueryClient 설정

```typescript
// src/lib/queryClient.ts
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      // 5분간 캐시 유효
      staleTime: 1000 * 60 * 5,
      // 재시도 횟수
      retry: 1,
      // 윈도우 포커스 시 리페치
      refetchOnWindowFocus: false,
    },
    mutations: {
      retry: 0,
    },
  },
});
```

### Provider 설정

```typescript
// src/main.tsx
import { QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { queryClient } from '@/lib/queryClient';

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <Router />
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```

### API 클라이언트

```typescript
// src/lib/api.ts
import { useAuthStore } from '@/stores/authStore';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8080';

async function fetchWithAuth(url: string, options: RequestInit = {}) {
  const token = useAuthStore.getState().token;

  const headers: HeadersInit = {
    'Content-Type': 'application/json',
    ...options.headers,
  };

  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  const response = await fetch(`${API_BASE_URL}${url}`, {
    ...options,
    headers,
  });

  if (!response.ok) {
    throw new Error(`API Error: ${response.status}`);
  }

  return response.json();
}

export const api = {
  get: (url: string) => fetchWithAuth(url),
  post: (url: string, data: unknown) =>
    fetchWithAuth(url, { method: 'POST', body: JSON.stringify(data) }),
  put: (url: string, data: unknown) =>
    fetchWithAuth(url, { method: 'PUT', body: JSON.stringify(data) }),
  delete: (url: string) =>
    fetchWithAuth(url, { method: 'DELETE' }),
};
```

---

## 커스텀 훅 패턴

### 데이터 조회 훅

```typescript
// src/features/study/hooks/useStudies.ts
import { useQuery } from '@tanstack/react-query';
import { api } from '@/lib/api';
import type { Study, StudyFilters } from '../types';

export function useStudies(filters?: StudyFilters) {
  return useQuery({
    queryKey: ['studies', filters],
    queryFn: () => api.get('/api/bff/studies', { params: filters }),
  });
}

export function useStudy(studyId: string) {
  return useQuery({
    queryKey: ['study', studyId],
    queryFn: () => api.get(`/api/bff/studies/${studyId}`),
    enabled: !!studyId,
  });
}

export function useStudyFull(studyId: string) {
  return useQuery({
    queryKey: ['study', studyId, 'full'],
    queryFn: () => api.get(`/api/bff/studies/${studyId}/full`),
    enabled: !!studyId,
  });
}
```

### 뮤테이션 훅

```typescript
// src/features/study/hooks/useAnalyze.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { api } from '@/lib/api';

export function useAnalyzeStudy() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (studyId: string) =>
      api.post(`/api/bff/studies/${studyId}/analyze`, {}),
    onSuccess: (_, studyId) => {
      // 캐시 무효화
      queryClient.invalidateQueries({ queryKey: ['study', studyId] });
    },
  });
}
```

### 파일 업로드 훅

```typescript
// src/features/upload/hooks/useUpload.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { useAuthStore } from '@/stores/authStore';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8080';

interface UploadProgress {
  loaded: number;
  total: number;
  percentage: number;
}

export function useUploadDicom() {
  const queryClient = useQueryClient();
  const token = useAuthStore((state) => state.token);

  return useMutation({
    mutationFn: async ({
      file,
      onProgress
    }: {
      file: File;
      onProgress?: (progress: UploadProgress) => void;
    }) => {
      const formData = new FormData();
      formData.append('file', file);

      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable && onProgress) {
            onProgress({
              loaded: e.loaded,
              total: e.total,
              percentage: Math.round((e.loaded / e.total) * 100),
            });
          }
        });

        xhr.addEventListener('load', () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            resolve(JSON.parse(xhr.responseText));
          } else {
            reject(new Error(`Upload failed: ${xhr.status}`));
          }
        });

        xhr.addEventListener('error', () => reject(new Error('Upload failed')));

        xhr.open('POST', `${API_BASE_URL}/api/minipacs/dicom/upload`);
        if (token) {
          xhr.setRequestHeader('Authorization', `Bearer ${token}`);
        }
        xhr.send(formData);
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['studies'] });
    },
  });
}
```

---

## 상태 분류 가이드

### Client State (Zustand)

| 상태 | 설명 |
|-----|------|
| 인증 상태 | user, token, isAuthenticated |
| UI 상태 | sidebarOpen, theme, modal |
| 폼 상태 | 임시 입력값 (제출 전) |
| 네비게이션 | 현재 탭, 필터 선택 |

### Server State (TanStack Query)

| 상태 | 설명 |
|-----|------|
| 스터디 목록 | `/api/bff/studies` |
| 스터디 상세 | `/api/bff/studies/{id}` |
| 분석 결과 | `/api/bff/studies/{id}/full` |
| 사용자 정보 | `/api/users/me` |

---

## 폴더 구조

```
src/
├── stores/                    # Zustand 스토어
│   ├── authStore.ts
│   ├── uiStore.ts
│   └── index.ts
├── lib/
│   ├── queryClient.ts         # TanStack Query 설정
│   └── api.ts                 # API 클라이언트
└── features/
    └── study/
        └── hooks/             # Feature별 Query 훅
            ├── useStudies.ts
            ├── useStudy.ts
            └── useAnalyze.ts
```

---

## 베스트 프랙티스

### 1. Query Key 규칙

```typescript
// 계층적 구조 사용
['studies']                        // 전체 목록
['studies', filters]               // 필터링된 목록
['study', studyId]                 // 단일 조회
['study', studyId, 'full']         // 상세 조회
```

### 2. 낙관적 업데이트

```typescript
const mutation = useMutation({
  mutationFn: updateStudy,
  onMutate: async (newData) => {
    await queryClient.cancelQueries({ queryKey: ['study', id] });
    const previous = queryClient.getQueryData(['study', id]);
    queryClient.setQueryData(['study', id], newData);
    return { previous };
  },
  onError: (err, _, context) => {
    queryClient.setQueryData(['study', id], context?.previous);
  },
});
```

### 3. 인증 토큰 갱신

```typescript
// Zustand와 TanStack Query 연동 - Fetch Wrapper 패턴
const fetchWithAuth = async (url: string, options: RequestInit = {}) => {
  const token = useAuthStore.getState().token;

  const response = await fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      Authorization: `Bearer ${token}`,
    },
  });

  if (response.status === 401) {
    const newToken = await refreshToken();
    useAuthStore.getState().setToken(newToken);
    // 재시도
    return fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        Authorization: `Bearer ${newToken}`,
      },
    });
  }

  return response;
};
```

---

## 참고 자료

- [Zustand 공식 문서](https://zustand-demo.pmnd.rs/)
- [TanStack Query 공식 문서](https://tanstack.com/query/latest)
- [React State Management 2025](https://www.developerway.com/posts/react-state-management-2025)

---

*최종 수정: 2025-12-25*
