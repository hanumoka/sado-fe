# 테스팅 전략

> **Vitest + Testing Library + MSW**

---

## 개요

### 테스트 피라미드

```
        ┌─────────┐
        │   E2E   │  Playwright (적은 수)
        ├─────────┤
        │ 통합    │  Testing Library + MSW (중간)
        ├─────────┤
        │ 단위    │  Vitest (많은 수)
        └─────────┘
```

### 기술 스택

| 도구 | 역할 | 선택 이유 |
|-----|------|----------|
| **Vitest** | 단위 테스트 러너 | Vite 네이티브, Jest 호환 |
| **Testing Library** | 컴포넌트 테스트 | 사용자 관점 테스트 |
| **MSW** | API 모킹 | Service Worker 기반, 통합성 |
| **Playwright** | E2E 테스트 | 크로스 브라우저, 안정성 |

---

## 설치

```bash
# Vitest + Testing Library
npm install -D vitest @vitest/ui @vitest/coverage-v8
npm install -D @testing-library/react @testing-library/jest-dom @testing-library/user-event
npm install -D jsdom

# MSW
npm install -D msw

# Playwright (선택)
npm install -D @playwright/test
npx playwright install
```

---

## Vitest 설정

### vite.config.ts

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    include: ['src/**/*.{test,spec}.{js,ts,jsx,tsx}'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts',
      ],
    },
  },
});
```

### 테스트 셋업

```typescript
// src/test/setup.ts
import '@testing-library/jest-dom/vitest';
import { cleanup } from '@testing-library/react';
import { afterEach, beforeAll, afterAll } from 'vitest';
import { server } from './mocks/server';

// MSW 서버 설정
beforeAll(() => server.listen({ onUnhandledRequest: 'error' }));
afterEach(() => {
  cleanup();
  server.resetHandlers();
});
afterAll(() => server.close());
```

### 테스트 유틸리티

```typescript
// src/test/utils.tsx
import { ReactElement } from 'react';
import { render, RenderOptions } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { BrowserRouter } from 'react-router-dom';

const createTestQueryClient = () =>
  new QueryClient({
    defaultOptions: {
      queries: {
        retry: false,
      },
    },
  });

interface WrapperProps {
  children: React.ReactNode;
}

function AllProviders({ children }: WrapperProps) {
  const queryClient = createTestQueryClient();

  return (
    <QueryClientProvider client={queryClient}>
      <BrowserRouter>
        {children}
      </BrowserRouter>
    </QueryClientProvider>
  );
}

const customRender = (
  ui: ReactElement,
  options?: Omit<RenderOptions, 'wrapper'>
) => render(ui, { wrapper: AllProviders, ...options });

export * from '@testing-library/react';
export { customRender as render };
```

---

## MSW 설정

### 핸들러 정의

```typescript
// src/test/mocks/handlers.ts
import { http, HttpResponse } from 'msw';

const API_BASE = 'http://localhost:8080';

export const handlers = [
  // 스터디 목록
  http.get(`${API_BASE}/api/bff/studies`, () => {
    return HttpResponse.json({
      content: [
        {
          id: '1',
          patientId: 'P001',
          patientName: 'John Doe',
          studyDate: '2025-01-01',
          modality: 'US',
          status: 'COMPLETED',
          seriesCount: 1,
          instanceCount: 50,
        },
        {
          id: '2',
          patientId: 'P002',
          patientName: 'Jane Smith',
          studyDate: '2025-01-02',
          modality: 'US',
          status: 'PENDING',
          seriesCount: 1,
          instanceCount: 45,
        },
      ],
      totalElements: 2,
      totalPages: 1,
      page: 0,
      size: 10,
    });
  }),

  // 스터디 상세
  http.get(`${API_BASE}/api/bff/studies/:id`, ({ params }) => {
    return HttpResponse.json({
      id: params.id,
      patientId: 'P001',
      patientName: 'John Doe',
      studyDate: '2025-01-01',
      modality: 'US',
      status: 'COMPLETED',
      seriesCount: 1,
      instanceCount: 50,
    });
  }),

  // 분석 요청
  http.post(`${API_BASE}/api/bff/studies/:id/analyze`, () => {
    return HttpResponse.json({
      message: 'Analysis started',
      workflowId: 'wf-123',
    });
  }),

  // 분석 결과
  http.get(`${API_BASE}/api/bff/studies/:id/full`, ({ params }) => {
    return HttpResponse.json({
      study: {
        id: params.id,
        patientName: 'John Doe',
        status: 'COMPLETED',
      },
      analysis: {
        id: 'a1',
        studyId: params.id,
        ejectionFraction: 62.5,
        endDiastolicVolume: 120,
        endSystolicVolume: 45,
        analyzedAt: '2025-01-01T10:00:00Z',
      },
    });
  }),
];
```

### MSW 서버

```typescript
// src/test/mocks/server.ts
import { setupServer } from 'msw/node';
import { handlers } from './handlers';

export const server = setupServer(...handlers);
```

### 브라우저용 (개발 시)

```typescript
// src/test/mocks/browser.ts
import { setupWorker } from 'msw/browser';
import { handlers } from './handlers';

export const worker = setupWorker(...handlers);
```

---

## 단위 테스트

### 유틸리티 함수 테스트

```typescript
// src/lib/__tests__/utils.test.ts
import { describe, it, expect } from 'vitest';
import { cn, formatDate, formatPercentage } from '../utils';

describe('cn', () => {
  it('merges class names', () => {
    expect(cn('foo', 'bar')).toBe('foo bar');
  });

  it('handles conditional classes', () => {
    expect(cn('foo', false && 'bar', 'baz')).toBe('foo baz');
  });
});

describe('formatDate', () => {
  it('formats date correctly', () => {
    expect(formatDate('2025-01-15')).toBe('2025년 1월 15일');
  });
});

describe('formatPercentage', () => {
  it('formats percentage with one decimal', () => {
    expect(formatPercentage(62.567)).toBe('62.6%');
  });
});
```

### 커스텀 훅 테스트

```typescript
// src/features/study/hooks/__tests__/useStudies.test.ts
import { describe, it, expect } from 'vitest';
import { renderHook, waitFor } from '@testing-library/react';
import { useStudies } from '../useStudies';
import { createWrapper } from '@/test/utils';

describe('useStudies', () => {
  it('fetches studies successfully', async () => {
    const { result } = renderHook(() => useStudies(), {
      wrapper: createWrapper(),
    });

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true);
    });

    expect(result.current.data?.content).toHaveLength(2);
    expect(result.current.data?.content[0].patientName).toBe('John Doe');
  });

  it('handles filters', async () => {
    const { result } = renderHook(
      () => useStudies({ patientName: 'John' }),
      { wrapper: createWrapper() }
    );

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true);
    });
  });
});
```

---

## 컴포넌트 테스트

### 기본 컴포넌트 테스트

```typescript
// src/features/study/components/__tests__/StudyCard.test.tsx
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@/test/utils';
import { StudyCard } from '../StudyCard';

const mockStudy = {
  id: '1',
  patientId: 'P001',
  patientName: 'John Doe',
  studyDate: '2025-01-01',
  modality: 'US',
  status: 'COMPLETED' as const,
  seriesCount: 1,
  instanceCount: 50,
};

describe('StudyCard', () => {
  it('renders study information', () => {
    render(<StudyCard study={mockStudy} />);

    expect(screen.getByText('John Doe')).toBeInTheDocument();
    expect(screen.getByText('COMPLETED')).toBeInTheDocument();
  });

  it('calls onClick when clicked', () => {
    const handleClick = vi.fn();
    render(<StudyCard study={mockStudy} onClick={handleClick} />);

    fireEvent.click(screen.getByText('John Doe'));
    expect(handleClick).toHaveBeenCalledWith(mockStudy);
  });

  it('shows pending badge for pending status', () => {
    const pendingStudy = { ...mockStudy, status: 'PENDING' as const };
    render(<StudyCard study={pendingStudy} />);

    expect(screen.getByText('PENDING')).toBeInTheDocument();
  });
});
```

### 데이터 페칭 컴포넌트 테스트

```typescript
// src/features/study/components/__tests__/StudyList.test.tsx
import { describe, it, expect } from 'vitest';
import { render, screen, waitFor } from '@/test/utils';
import { StudyList } from '../StudyList';

describe('StudyList', () => {
  it('shows loading state initially', () => {
    render(<StudyList />);
    expect(screen.getAllByTestId('skeleton')).toHaveLength(6);
  });

  it('renders study list after loading', async () => {
    render(<StudyList />);

    await waitFor(() => {
      expect(screen.getByText('John Doe')).toBeInTheDocument();
    });

    expect(screen.getByText('Jane Smith')).toBeInTheDocument();
  });

  it('shows empty state when no studies', async () => {
    // MSW 핸들러 오버라이드
    server.use(
      http.get(`${API_BASE}/api/bff/studies`, () => {
        return HttpResponse.json({
          content: [],
          totalElements: 0,
          totalPages: 0,
          page: 0,
          size: 10,
        });
      })
    );

    render(<StudyList />);

    await waitFor(() => {
      expect(screen.getByText('No studies found')).toBeInTheDocument();
    });
  });
});
```

### 사용자 상호작용 테스트

```typescript
// src/features/upload/components/__tests__/UploadDropzone.test.tsx
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@/test/utils';
import userEvent from '@testing-library/user-event';
import { UploadDropzone } from '../UploadDropzone';

describe('UploadDropzone', () => {
  it('accepts dropped files', async () => {
    render(<UploadDropzone />);

    const dropzone = screen.getByText(/drag.*drop/i);
    const file = new File(['dummy'], 'test.dcm', { type: 'application/dicom' });

    fireEvent.drop(dropzone, {
      dataTransfer: {
        files: [file],
      },
    });

    await waitFor(() => {
      expect(screen.getByText(/uploading/i)).toBeInTheDocument();
    });
  });

  it('shows progress during upload', async () => {
    render(<UploadDropzone />);

    const input = screen.getByRole('presentation').querySelector('input');
    const file = new File(['dummy'], 'test.dcm', { type: 'application/dicom' });

    await userEvent.upload(input!, file);

    await waitFor(() => {
      expect(screen.getByRole('progressbar')).toBeInTheDocument();
    });
  });
});
```

---

## E2E 테스트 (Playwright)

### Playwright 설정

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
});
```

### E2E 테스트

```typescript
// e2e/study-workflow.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Study Workflow', () => {
  test('user can view study list', async ({ page }) => {
    await page.goto('/');

    await expect(page.getByRole('heading', { name: 'Studies' })).toBeVisible();
    await expect(page.getByText('John Doe')).toBeVisible();
  });

  test('user can view study details', async ({ page }) => {
    await page.goto('/');

    await page.click('text=John Doe');

    await expect(page).toHaveURL(/\/studies\/1/);
    await expect(page.getByText('Study Details')).toBeVisible();
  });

  test('user can request analysis', async ({ page }) => {
    await page.goto('/studies/1');

    await page.click('button:has-text("Analyze")');

    await expect(page.getByText('Analysis started')).toBeVisible();
  });
});
```

---

## 테스트 스크립트

```json
// package.json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest run --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui"
  }
}
```

---

## 폴더 구조

```
src/
├── test/
│   ├── setup.ts              # 테스트 셋업
│   ├── utils.tsx             # 테스트 유틸리티
│   └── mocks/
│       ├── handlers.ts       # MSW 핸들러
│       ├── server.ts         # Node용 MSW 서버
│       └── browser.ts        # 브라우저용 MSW
│
└── features/
    └── study/
        └── components/
            └── __tests__/    # 컴포넌트 테스트
                ├── StudyCard.test.tsx
                └── StudyList.test.tsx

e2e/                          # E2E 테스트
├── study-workflow.spec.ts
└── upload.spec.ts
```

---

## 참고 자료

- [Vitest 공식 문서](https://vitest.dev/)
- [Testing Library 공식 문서](https://testing-library.com/)
- [MSW 공식 문서](https://mswjs.io/)
- [Playwright 공식 문서](https://playwright.dev/)

---

*최종 수정: 2025-12-25*
